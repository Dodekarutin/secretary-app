# PLAN.md - タスク分解画面 UI/UX 改善

最終更新: 2025-10-28

## Overview

タスク分解画面（`/decomposer`）で、AI が生成した 1 つの大きな親タスクと、その配下の子・孫タスクを階層的に表示し、ユーザーが自由に編集・調整できる UI を実装する。

## Current State（現状）

### 実装状況
- AI（Gemini）がテキストまたは音声入力からタスクを 3 階層（親 → 子 → 孫）に分解
- 音声入力対応（Whisper API）は実装済み
- カンバンへの追加機能は動作中

### 現在の制限
- 単調なリスト表示で、階層構造が視覚的にわかりにくい
- 個別タスクの編集・削除ができない（一括選択のみ）
- メタ情報（期限、工数、優先度、メモ）の個別設定ができない
- チェックボックスでの一括設定は可能だが、個別のカスタマイズができない
- 親タスク全体のサマリー（合計工数、完了予定日、進捗率）が表示されない
- タスクの手動追加や並び替えができない

### 技術的現状
- 実装: `src/features/decomposer/decomposer-root.tsx`
- 型定義: `src/lib/decomposer.ts`
- AI クライアント: `src/lib/aiClient.ts`

## Background（背景・改善の必要性）

### ユーザビリティの問題
1. **階層構造が不明瞭**: 単調なリスト表示では親子関係が把握しづらく、タスクの全体像を理解するのに時間がかかる
2. **編集の柔軟性不足**: AI が生成したタスクをそのまま使うか、全体を破棄するかの二択しかなく、部分的な調整ができない
3. **情報不足**: 個別タスクに期限や工数を設定できないため、プロジェクト管理に必要な情報が欠落

### プロジェクト管理上の課題
1. **見積もりの精度**: 子タスクの工数を積み上げた親タスクの総工数が可視化されないため、計画精度が低い
2. **優先度の設定**: タスクごとの優先度付けができず、作業の順序が不明確
3. **進捗管理**: 親タスク全体の進捗状況が把握できない

### 拡張性の制約
- AI 生成タスクに手動で追加タスクを加えることができない
- 生成後の並び替えや階層変更ができない
- 一度生成したタスクの再利用（テンプレート化）ができない

これらの問題により、現在のタスク分解画面は「AI が提案したタスク構造の確認」にとどまり、実際のプロジェクト管理ツールとしての活用が困難な状態にある。

## Solution Plan（修正プラン）

### アプローチ

1 つの親タスクを中心とした階層的なカードビューを実装し、各タスクの個別編集、メタ情報設定、手動追加、並び替え機能を段階的に追加することで、実用的なプロジェクト管理ツールへと進化させる。

### Development Phases（開発フェーズ）

#### Phase 1 – 単一親タスクビューの基本構造

**目標**: 1 つの親タスクカードに階層構造を視覚化

- ☐ 親タスクを大きなカードコンテナとして表示（`ParentTaskCard`コンポーネント）
- ☐ 子・孫タスクを階層的に表示（インデント + 接続線）
- ☐ 階層レベルごとの色分け（親: brand, 第 1 層: accent, 第 2 層: グレー系）
- ☐ 親タスクヘッダーに全体サマリー（合計工数・完了予定日・進捗率）を自動計算表示
- ☐ 展開/折りたたみアイコンで階層表示を制御
- ☐ レスポンシブ対応（モバイル: 縦積み、デスクトップ: 最適レイアウト）

**成果物**:

- `src/components/decomposer/parent-task-card.tsx`
- `src/components/decomposer/hierarchical-task-item.tsx`
- サマリー自動計算ユーティリティ
- ユニットテスト

---

#### Phase 2 – インライン編集機能

**目標**: 親・子・孫すべてのタスクを編集可能に

- ☐ 親タスク名・説明のインライン編集（Enter 保存、Esc キャンセル）
- ☐ 子・孫タスク名のインライン編集（ダブルクリックまたは編集ボタン）
- ☐ 子・孫タスクの個別削除（確認ダイアログ、子削除時は孫も削除）
- ☐ 親タスクはリセット機能で全体クリア（削除不可）
- ☐ キーボードショートカット対応
- ☐ 状態管理を`useReducer`で堅牢化（`ParentTaskState`）

**成果物**:

- 編集・削除機能の実装
- `parentTaskReducer`状態管理
- 編集/削除のユニットテスト

---

#### Phase 3 – メタ情報の追加

**目標**: 工数・期限・優先度・メモを設定し、親タスクで自動集計

- ☐ 型定義拡張（`ParentTask`, `DecomposedTask`にメタ情報フィールド追加）
- ☐ 各子・孫タスクに個別の期限設定（デートピッカー）
- ☐ 見積もり工数入力（0.5h 刻み）、孫 → 子 → 親で自動集計
- ☐ 優先度選択（高/中/低の 3 段階、色分け）
- ☐ メモ/説明追加（最大 200 文字、展開式）
- ☐ 一括設定との統合（個別設定が優先、UI で明示）
- ☐ サマリー自動計算ロジック実装（合計工数、最遅期限、進捗率）

**成果物**:

- メタ情報入力 UI
- `calculateParentSummary`関数
- サマリー計算のユニットテスト

---

#### Phase 4 – タスク追加機能

**目標**: ユーザーが手動で子・孫タスクを追加可能に

- ☐ 親タスク配下に「+ 子タスクを追加」ボタン
- ☐ 各子タスクに「+ サブタスクを追加」ボタン
- ☐ 階層制限（最大 3 レベル）を視覚的に表示、制限到達時はボタン非表示
- ☐ 追加時に自動的に編集モードに遷移
- ☐ タスク数制限（最大 50 個、パフォーマンス考慮）
- ☐ 追加後のサマリー自動更新

**成果物**:

- タスク追加 UI
- 階層制限ロジック
- 追加機能のユニットテスト

---

#### Phase 5 – ドラッグ&ドロップ並び替え

**目標**: 同一階層内および階層間でのタスク移動

- ☐ D&D ライブラリ選定（`@dnd-kit/core`推奨）
- ☐ 同一階層内での並び替え（子同士、孫同士）
- ☐ 階層間の移動（子 → 別の子の孫、孫 → 別の子の配下）
- ☐ ドロップゾーンの視覚化
- ☐ 無効な移動の防止（循環参照、階層制限超過）
- ☐ 親タスク自体は移動不可
- ☐ 移動後のサマリー自動更新
- ☐ キーボード操作での並び替え（アクセシビリティ）

**成果物**:

- D&D 機能実装
- 並び替えロジック
- エッジケーステスト

---

#### Phase 6 – AI 支援機能 _Optional_

**目標**: AI による分析と改善提案

- ☐ 親タスク全体の AI 分析（抜け漏れ検出、工数妥当性評価）
- ☐ 依存関係の自動提案
- ☐ 「別の分解案を見る」ボタンで再生成
- ☐ 現在の編集内容保持（確認ダイアログ）

---

### Technical Considerations（技術的考慮事項）

#### 状態管理

```tsx
type ParentTaskState = {
  parentTask: ParentTask;
  selectedPaths: Set<string>;
  editingPath: string | null;
};

type Action =
  | { type: "UPDATE_PARENT_TITLE"; title: string; description?: string }
  | { type: "UPDATE_TASK_TITLE"; path: string; title: string }
  | { type: "DELETE_TASK"; path: string }
  | { type: "ADD_CHILD_TASK"; task: DecomposedTask }
  | { type: "UPDATE_META"; path: string; meta: Partial<DecomposedTask> }
  | { type: "RECALCULATE_SUMMARY" };
```

#### パフォーマンス最適化

- `React.memo`でコンポーネントメモ化
- `useMemo`でサマリー計算メモ化
- 30+タスク時は仮想スクロール検討
- 階層展開状態をローカルステートで管理

#### アクセシビリティ

- ARIA: `role="tree"`, `role="treeitem"`, `aria-label`
- キーボード: Tab/Enter/Esc/矢印キー/Space
- スクリーンリーダー: 階層レベルとサマリーのアナウンス
- フォーカス管理（編集時の自動フォーカス/復帰）

#### レスポンシブ

- モバイル: 縦積み、タッチ操作最適化
- タブレット: 2 カラム
- デスクトップ: 最適幅設定

---

## Risks & Mitigations

| リスク                             | 影響 | 確率 | 対策                                  |
| ---------------------------------- | ---- | ---- | ------------------------------------- |
| D&D ライブラリのバンドルサイズ増加 | 中   | 高   | Tree-shaking、遅延ロード              |
| 複雑な状態管理による不具合         | 高   | 中   | useReducer + 厳格な型定義、テスト充実 |
| モバイルでの D&D 操作性            | 中   | 中   | タッチ最適化、代替 UI（矢印ボタン）   |
| 大量タスク時のパフォーマンス低下   | 中   | 低   | 仮想スクロール、タスク数制限          |

---

### Deliverables Checklist（成果物チェックリスト）

#### Phase 1

- [ ] ParentTaskCard コンポーネント
- [ ] HierarchicalTaskItem コンポーネント
- [ ] サマリー自動計算ロジック
- [ ] 階層表示のユニットテスト

#### Phase 2

- [ ] インライン編集機能
- [ ] 削除機能（確認ダイアログ）
- [ ] parentTaskReducer 実装
- [ ] 編集/削除のテスト

#### Phase 3

- [ ] メタ情報入力 UI（期限/工数/優先度/メモ）
- [ ] calculateParentSummary 関数
- [ ] 一括設定との統合
- [ ] サマリー計算テスト

#### Phase 4

- [ ] タスク追加 UI
- [ ] 階層制限ロジック
- [ ] 追加機能のテスト

#### Phase 5

- [ ] D&D 機能実装
- [ ] 階層間移動ロジック
- [ ] アクセシビリティ対応
- [ ] エッジケーステスト

#### 統合テスト

- [ ] AI 分解 → 編集 → メタ情報設定 → カンバン追加の一連フロー
- [ ] サマリー自動計算の統合テスト

#### ドキュメント

- [x] PLAN.md 作成
- [ ] コンポーネント API ドキュメント
- [ ] 状態管理フロー図

---

## Future Enhancements

- タスクの自動推定（過去データから工数予測）
- 依存関係の自動検出とグラフ表示
- 親タスクテンプレート化（「API 実装」「機能開発」等）
- リアルタイム編集（複数ユーザー）
- 担当者割り当て
- 親タスクのクローン機能

---

## 変更履歴

| 日付       | 変更内容                                                                  |
| ---------- | ------------------------------------------------------------------------- |
| 2025-10-28 | 初版作成（タスク分解 UI/UX 改善プラン）                                   |
| 2025-10-28 | 方針を単一親タスク中心の階層ビューに統一、代替案を削除                    |
| 2025-10-28 | 参考事例に基づき簡潔な形式に修正                                          |
| 2025-10-28 | スケジュールと工数見積もりを削除                                          |
| 2025-10-28 | 構造を「現状」「背景」「修正プラン」形式に再構成し、問題点と解決策を明確化 |

---

## 関連ドキュメント

- 実装: `src/features/decomposer/decomposer-root.tsx`
- 型定義: `src/lib/decomposer.ts`
- AI: `src/lib/aiClient.ts`
- 設計: `docs/ui-spec.md`, `docs/info-architecture.md`
- 開発: `AGENTS.md`, `README.md`
