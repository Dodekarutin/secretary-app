# PLAN.md - タスク分解画面 UI/UX 改善

最終更新: 2025-10-28

## Goal

タスク分解画面（`/decomposer`）で、AI が生成した 1 つの大きな親タスクと、その配下の子・孫タスクを階層的に表示し、ユーザーが自由に編集・調整できる UI を実装する。

## 現状

- AI（Gemini）がテキストまたは音声入力からタスクを 3 階層（親 → 子 → 孫）に分解
- 現在は単調なリスト表示で、編集・削除・メタ情報設定ができない
- チェックボックスでの選択と一括設定は可能だが、個別のカスタマイズができない
- 音声入力対応（Whisper API）は実装済み
- カンバンへの追加機能は動作中

## 背景

- 現状 UI は単調なリスト表示で、編集・削除・メタ情報の個別設定ができず、分解結果を活用した具体的な計画立案につながりにくい
- AI により 3 階層でタスクが生成される一方、表示は階層構造を十分に可視化できていないため、全体像の把握と局所編集の両立が難しい
- 音声入力やカンバン追加といった入出力の土台はあるため、UI/UX の強化がボトルネックとなっている
- 進捗や工数などのメタ情報を集計し、アクセシビリティと操作性（キーボード操作等）を高める必要がある

## 修正プラン

### Phase 1 – 単一親タスクビューの基本構造

**目標**: 1 つの親タスクカードに階層構造を視覚化

- ☐ 親タスクを大きなカードコンテナとして表示（`ParentTaskCard`コンポーネント）
- ☐ 子・孫タスクを階層的に表示（インデント + 接続線）
- ☐ 階層レベルごとの色分け（親: brand, 第 1 層: accent, 第 2 層: グレー系）
- ☐ 親タスクヘッダーに全体サマリー（合計工数・完了予定日・進捗率）を自動計算表示
- ☐ 展開/折りたたみアイコンで階層表示を制御
- ☐ レスポンシブ対応（モバイル: 縦積み、デスクトップ: 最適レイアウト）

**成果物**:

- `src/components/decomposer/parent-task-card.tsx`
- `src/components/decomposer/hierarchical-task-item.tsx`
- サマリー自動計算ユーティリティ
- ユニットテスト

---

### Phase 2 – インライン編集機能

**目標**: 親・子・孫すべてのタスクを編集可能に

- ☐ 親タスク名・説明のインライン編集（Enter 保存、Esc キャンセル）
- ☐ 子・孫タスク名のインライン編集（ダブルクリックまたは編集ボタン）
- ☐ 子・孫タスクの個別削除（確認ダイアログ、子削除時は孫も削除）
- ☐ 親タスクはリセット機能で全体クリア（削除不可）
- ☐ キーボードショートカット対応
- ☐ 状態管理を`useReducer`で堅牢化（`ParentTaskState`）

**成果物**:

- 編集・削除機能の実装
- `parentTaskReducer`状態管理
- 編集/削除のユニットテスト

---

### Phase 3 – メタ情報の追加

**目標**: 工数・期限・優先度・メモを設定し、親タスクで自動集計

- ☐ 型定義拡張（`ParentTask`, `DecomposedTask`にメタ情報フィールド追加）
- ☐ 各子・孫タスクに個別の期限設定（デートピッカー）
- ☐ 見積もり工数入力（0.5h 刻み）、孫 → 子 → 親で自動集計
- ☐ 優先度選択（高/中/低の 3 段階、色分け）
- ☐ メモ/説明追加（最大 200 文字、展開式）
- ☐ 一括設定との統合（個別設定が優先、UI で明示）
- ☐ サマリー自動計算ロジック実装（合計工数、最遅期限、進捗率）

**成果物**:

- メタ情報入力 UI
- `calculateParentSummary`関数
- サマリー計算のユニットテスト

---

### Phase 4 – タスク追加機能

**目標**: ユーザーが手動で子・孫タスクを追加可能に

- ☐ 親タスク配下に「+ 子タスクを追加」ボタン
- ☐ 各子タスクに「+ サブタスクを追加」ボタン
- ☐ 階層制限（最大 3 レベル）を視覚的に表示、制限到達時はボタン非表示
- ☐ 追加時に自動的に編集モードに遷移
- ☐ タスク数制限（最大 50 個、パフォーマンス考慮）
- ☐ 追加後のサマリー自動更新

**成果物**:

- タスク追加 UI
- 階層制限ロジック
- 追加機能のユニットテスト

---

### Phase 5 – ドラッグ&ドロップ並び替え

**目標**: 同一階層内および階層間でのタスク移動

- ☐ D&D ライブラリ選定（`@dnd-kit/core`推奨）
- ☐ 同一階層内での並び替え（子同士、孫同士）
- ☐ 階層間の移動（子 → 別の子の孫、孫 → 別の子の配下）
- ☐ ドロップゾーンの視覚化
- ☐ 無効な移動の防止（循環参照、階層制限超過）
- ☐ 親タスク自体は移動不可
- ☐ 移動後のサマリー自動更新
- ☐ キーボード操作での並び替え（アクセシビリティ）

**成果物**:

- D&D 機能実装
- 並び替えロジック
- エッジケーステスト

---

### Phase 6 – AI 支援機能 _Optional_

**目標**: AI による分析と改善提案

- ☐ 親タスク全体の AI 分析（抜け漏れ検出、工数妥当性評価）
- ☐ 依存関係の自動提案
- ☐ 「別の分解案を見る」ボタンで再生成
- ☐ 現在の編集内容保持（確認ダイアログ）

---

## Technical Considerations

### 状態管理

```tsx
type ParentTaskState = {
  parentTask: ParentTask;
  selectedPaths: Set<string>;
  editingPath: string | null;
};

type Action =
  | { type: "UPDATE_PARENT_TITLE"; title: string; description?: string }
  | { type: "UPDATE_TASK_TITLE"; path: string; title: string }
  | { type: "DELETE_TASK"; path: string }
  | { type: "ADD_CHILD_TASK"; task: DecomposedTask }
  | { type: "UPDATE_META"; path: string; meta: Partial<DecomposedTask> }
  | { type: "RECALCULATE_SUMMARY" };
```

### パフォーマンス最適化

- `React.memo`でコンポーネントメモ化
- `useMemo`でサマリー計算メモ化
- 30+タスク時は仮想スクロール検討
- 階層展開状態をローカルステートで管理

### アクセシビリティ

- ARIA: `role="tree"`, `role="treeitem"`, `aria-label`
- キーボード: Tab/Enter/Esc/矢印キー/Space
- スクリーンリーダー: 階層レベルとサマリーのアナウンス
- フォーカス管理（編集時の自動フォーカス/復帰）

### レスポンシブ

- モバイル: 縦積み、タッチ操作最適化
- タブレット: 2 カラム
- デスクトップ: 最適幅設定

---

## Risks & Mitigations

| リスク                             | 影響 | 確率 | 対策                                  |
| ---------------------------------- | ---- | ---- | ------------------------------------- |
| D&D ライブラリのバンドルサイズ増加 | 中   | 高   | Tree-shaking、遅延ロード              |
| 複雑な状態管理による不具合         | 高   | 中   | useReducer + 厳格な型定義、テスト充実 |
| モバイルでの D&D 操作性            | 中   | 中   | タッチ最適化、代替 UI（矢印ボタン）   |
| 大量タスク時のパフォーマンス低下   | 中   | 低   | 仮想スクロール、タスク数制限          |

---

## Deliverables Checklist

### Phase 1

- [ ] ParentTaskCard コンポーネント
- [ ] HierarchicalTaskItem コンポーネント
- [ ] サマリー自動計算ロジック
- [ ] 階層表示のユニットテスト

### Phase 2

- [ ] インライン編集機能
- [ ] 削除機能（確認ダイアログ）
- [ ] parentTaskReducer 実装
- [ ] 編集/削除のテスト

### Phase 3

- [ ] メタ情報入力 UI（期限/工数/優先度/メモ）
- [ ] calculateParentSummary 関数
- [ ] 一括設定との統合
- [ ] サマリー計算テスト

### Phase 4

- [ ] タスク追加 UI
- [ ] 階層制限ロジック
- [ ] 追加機能のテスト

### Phase 5

- [ ] D&D 機能実装
- [ ] 階層間移動ロジック
- [ ] アクセシビリティ対応
- [ ] エッジケーステスト

### 統合テスト

- [ ] AI 分解 → 編集 → メタ情報設定 → カンバン追加の一連フロー
- [ ] サマリー自動計算の統合テスト

### ドキュメント

- [x] PLAN.md 作成
- [ ] コンポーネント API ドキュメント
- [ ] 状態管理フロー図

---

## Future Enhancements

- タスクの自動推定（過去データから工数予測）
- 依存関係の自動検出とグラフ表示
- 親タスクテンプレート化（「API 実装」「機能開発」等）
- リアルタイム編集（複数ユーザー）
- 担当者割り当て
- 親タスクのクローン機能

---

## 変更履歴

| 日付       | 変更内容                                               |
| ---------- | ------------------------------------------------------ |
| 2025-10-28 | 初版作成（タスク分解 UI/UX 改善プラン）                |
| 2025-10-28 | 方針を単一親タスク中心の階層ビューに統一、代替案を削除 |
| 2025-10-28 | 参考事例に基づき簡潔な形式に修正                       |
| 2025-10-28 | スケジュールと工数見積もりを削除                       |

---

## 関連ドキュメント

- 実装: `src/features/decomposer/decomposer-root.tsx`
- 型定義: `src/lib/decomposer.ts`
- AI: `src/lib/aiClient.ts`
- 設計: `docs/ui-spec.md`, `docs/info-architecture.md`
- 開発: `AGENTS.md`, `README.md`
